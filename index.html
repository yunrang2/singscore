<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>ë¬´ì–´ë„¤ ê¹¨ì•Œ ë…¸ë˜ìë‘</title>

    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        @font-face {
            font-family: 'DNFBitBitv2';
            src: url('https://cdn.jsdelivr.net/gh/yunrang2/upload@master/DNFBitBitv2.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }

        * {
            font-family: 'DNFBitBitv2', sans-serif;
            font-weight: normal;
            color: white;
            text-shadow:
                -1px -1px 0 #000,
                1px -1px 0 #000,
                -1px  1px 0 #000,
                1px  1px 0 #000,
                0px -1px 0 #000,
                0px  1px 0 #000,
                -1px  0px 0 #000,
                1px  0px 0 #000,
                -2px  0px 0 #000,
                2px  0px 0 #000,
                0px -2px 0 #000,
                0px  2px 0 #000;

        }

        body {
            background: #00ff00;
            text-align: center;
            margin: 0;
        }

        table {
            margin: 20px auto;
            border-collapse: collapse;
            width: 100%;
            table-layout: fixed;
            background: #ffc0cb; /* í‘œ ë°°ê²½ í•‘í¬ */
        }

        th, td {
            border: 1px solid #ff69b4;
            padding: 6px;
            font-size: clamp(10px, 1.5vw, 16px);
            text-align: center;
            word-break: break-word;
            background-color: #ffc0cb;
        }

        th {
            white-space: nowrap;
        }

        input[type="number"] {
            width: 50px;
            max-width: 100%;
        }

        input, button {
            font-size: 16px;
            padding: 6px;
            margin: 4px;
            background: #ff69b4;
            color: white;
            border: 2px solid black;
            border-radius: 6px;
            box-shadow: 1px 1px 0 #000;
            transition: all 0.2s ease;
        }

        button {
            padding: 8px 14px;
            cursor: pointer;
        }

        button:hover {
            background: #ff85c1;
            transform: scale(1.05);
            box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        button:active {
            background: #cc3385;
            transform: scale(0.97);
        }

        .score-button {
            font-size: 10px;
            padding: 2px 4px;
            background-color: #ff69b4;
            border: 1px solid black;
            border-radius: 4px;
        }

        .score-button:hover {
            background-color: #ff85c1;
            transform: scale(1.05);
        }

        .score-button:active {
            background-color: #cc3385;
            transform: scale(0.97);
        }

        #modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
        }

        #modalContent {
            background-color: #ffc0cb;
            margin: 10% auto;
            padding: 20px;
            border: 2px solid #ff69b4;
            width: 300px;
        }

        #closeModal {
            float: right;
            cursor: pointer;
            color: red;
        }

        .active-row {
            background-color: #ff1493 !important;
        }

        #toggleJudgeBtnModal {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 12px;
            padding: 2px 6px;
            background: #ff69b4;
            border: 1px solid black;
            border-radius: 4px;
        }

        #scoreInputModal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
        }

        #scoreInputModalContent {
            position: relative;
            background: #ffc0cb;
            width: 300px;
            margin: 10% auto;
            padding: 20px;
            border: 2px solid #ff69b4;
        }

        #logContent {
            text-shadow: none !important;
        }

    </style>
</head>
<body>
    <div style="position: absolute; top: 10px; right: 10px;">
        <button onclick="resetAll()" style="font-size: 12px; padding: 2px 6px; border: 1px solid #888; background: #222; color: white;">ì´ˆê¸°í™”</button>
        <button onclick="resetSelectedCon()" style="font-size: 12px; padding: 2px 6px; border: 1px solid #888; background: #222; color: white;">ì„ íƒ ì½˜+ì ìˆ˜ ì´ˆê¸°í™”</button>
    </div>

    <h1>ğŸ¤ ë¬´ì–´ë„¤ ê¹¨ì•Œ ë…¸ë˜ìë‘</h1>

    <button onclick="openModal()">ì°¸ì—¬ì ì¶”ê°€</button>
    <button id="toggleBtn" onclick="toggleSingerVisibility()">ì°¸ê°€ì í‘œì‹œ</button>
    <button id="sortToggleBtn" onclick="toggleSortMode()">ìˆœìœ„ ì •ë ¬</button>
    <button onclick="openLogModal()">ë¡œê·¸ ë³´ê¸°</button>
    <button onclick="reprocessConLogs()">ë¡œê·¸ ì¬ì²˜ë¦¬</button>
    <button onclick="openManualConModal()">ì½˜ ìˆ˜ë™ ë°˜ì˜</button>

    <div id="modal">
        <div id="modalContent">
            <span id="closeModal" onclick="closeModal()">âœ–</span>
            <h2>ì°¸ì—¬ì ì¶”ê°€</h2>
            <input type="text" id="singer" placeholder="ì°¸ê°€ìëª…"><br>
            <input type="text" id="song" placeholder="ë…¸ë˜ ì œëª©" onkeydown="handleEnter(event)"><br>
            <button onclick="addEntry()">ì¶”ê°€</button>
        </div>
    </div>

    <div style="width: 100%;">
        <table id="scoreTable">
            <thead>
                <tr>
                    <th>ë…¸ë˜ ì¤‘</th>
                    <th>ìˆœì„œ</th>
                    <th><span id="singerHeaderText">ì°¸ê°€ì (ë¹„ê³µê°œ)</span></th>
                    <th>ë…¸ë˜ ì œëª©</th>
                    <th>ì ìˆ˜ ì…ë ¥</th>
                    <th>ì½˜ ì ìˆ˜</th>
                    <th>ì´ ì ìˆ˜</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>

    <div id="scoreInputModal" style="display:none; position:fixed; z-index:1001; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.8);">
        <div id="scoreInputModalContent">
            <button id="toggleJudgeBtnModal" onclick="toggleJudgeFieldFromModal()">ì¶”ê°€</button>
            <h2>ì ìˆ˜ ì…ë ¥</h2>
            <div id="dynamicScoreInputs"></div>
            <button onclick="saveScores()">ì €ì¥</button>
            <button onclick="closeScoreModal()">ì·¨ì†Œ</button>
        </div>
    </div>

    <div id="logModal" style="display:none; position:fixed; z-index:1001; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.8);">
        <div style="background:#fff0f5; color:#333; max-width:500px; width:90%; margin:10% auto; padding:20px; border:2px solid #ff69b4; position:relative;">
            <span onclick="closeLogModal()" style="position:absolute; top:10px; right:15px; color:red; cursor:pointer;">âœ–</span>
            <h2 style="margin-top:0;">ì½˜ ì ìˆ˜ ë¡œê·¸</h2>

            <select id="logFilterSelect" onchange="filterLogByParticipant()" style="margin-bottom:10px; padding:5px; width:100%;">
                <option value="">ì „ì²´ ë³´ê¸°</option>
            </select>

            <div id="logContent" style="height:300px; overflow-y:auto; font-size:14px; white-space:pre-line; background:#fff; border:1px solid #ccc; padding:10px; color:#000;"></div>
        </div>
    </div>

    <div id="manualConModal" style="display:none; position:fixed; z-index:1001; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.8);">
        <div style="background:#fff0f5; color:#000; width:300px; margin:10% auto; padding:20px; border:2px solid #ff69b4; position:relative;">
            <span onclick="closeManualConModal()" style="position:absolute; top:10px; right:15px; color:red; cursor:pointer;">âœ–</span>
            <h2>ì½˜ ìˆ˜ë™ ë°˜ì˜</h2>
            <label>ì°¸ê°€ì ë²ˆí˜¸: <input type="number" id="manualTarget" min="1" /></label><br><br>
            <label>ì½˜ ì ìˆ˜: <input type="number" id="manualAmount" /></label><br><br>
            <button onclick="applyManualCon()">ë°˜ì˜</button>
        </div>
    </div>

    <script>
        let participants = [];
        let originalOrder = [];
        let judgeCount = 3;
        let showSingers = false;
        let currentScoreIndex = null;
        let activeIndex = null;
        let lastMessageHash = null;
        let pendingContributions = {};
        let isSortedByScore = false;
        let conLogHistory = [];
        let contributionLogs = [];
        let assignedHistory = new Set();
        let lastCoinSender = null;
    
        function showVersion() {
            const version = 'v.2025.08.02.09';
            const versionDiv = document.createElement('div');
            versionDiv.textContent = version;
            versionDiv.style.position = 'fixed';
            versionDiv.style.top = '5px';
            versionDiv.style.left = '5px';
            versionDiv.style.fontSize = '10px';
            versionDiv.style.color = '#333';
            versionDiv.style.textShadow = '1px 1px 0 white';
            versionDiv.style.zIndex = '9999';
            document.body.appendChild(versionDiv);
            console.log(`âœ… í˜„ì¬ ìŠ¤í¬ë¦½íŠ¸ ë²„ì „: ${version}`);
        }
    
        window.addEventListener("message", (event) => {
            const { type, con, amount, ì°¸ê°€ì, nickname, raw } = event.data;
            console.log("ğŸ’Œ ë©”ì‹œì§€ ìˆ˜ì‹ ë¨:", event.data);
    
            const msgHash = JSON.stringify(event.data);
            if (msgHash === lastMessageHash) return;
            lastMessageHash = msgHash;
    
            if (type === "coin") {
                const value = parseInt(amount ?? con);
                if (!value || isNaN(value) || !nickname) return;
    
                // ìˆ˜ì •ëœ ë¡œì§: ë¬´ì¡°ê±´ ë³´ë¥˜ ìƒíƒœë¡œ ì €ì¥
                pendingContributions[nickname] = (pendingContributions[nickname] || 0) + value;
                console.log(`ğŸ’° ë³´ë¥˜ëœ ì ìˆ˜ ì €ì¥: ${nickname} â†’ ${value}ì `);
            }
    
            if (type === "assign") {
                const targetNum = parseInt(ì°¸ê°€ì);
                const senderNickname = nickname;
                
                const value = pendingContributions[senderNickname];
                
                if (!value || isNaN(targetNum)) {
                    console.log(`âš ï¸ í• ë‹¹ ì‹¤íŒ¨: ë³´ë¥˜ëœ ì ìˆ˜ê°€ ì—†ê±°ë‚˜ ì°¸ê°€ì ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.`);
                    return;
                }
                
                const idx = targetNum - 1;
                if (!participants[idx]) {
                    console.log(`âš ï¸ ì°¸ê°€ì ë²ˆí˜¸ ${targetNum}ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.`);
                    return;
                }
                
                const blindName = participants[idx].blindName || `ì°¸ê°€ì${idx + 1}`;
                
                const logKey = `${senderNickname}|${blindName}|${value}`;
                if (assignedHistory.has(logKey)) {
                    console.log(`âŒ ì¤‘ë³µ í• ë‹¹ ì‹œë„ ë°©ì§€: ${logKey}`);
                    return;
                }
                assignedHistory.add(logKey);
    
                participants[idx].score += value;
                participants[idx].conTotal = (participants[idx].conTotal || 0) + value;
    
                conLogHistory.push({
                    nickname: senderNickname,
                    participant: blindName,
                    value,
                    time: new Date().toLocaleString(),
                    logKey
                });
    
                delete pendingContributions[senderNickname];
                
                triggerConfetti();
                updateLogFilterOptions();
                saveData();
                renderTable();
                console.log(`âœ… ${senderNickname} â†’ ${blindName}ì—ê²Œ ${value}ì  ë°˜ì˜ë¨`);
            }
        });
    
        window.reprocessConLogs = function() {
            if (!confirm("ì €ì¥ëœ ë¡œê·¸ë¥¼ ë°”íƒ•ìœ¼ë¡œ ëª¨ë“  ì½˜ ì ìˆ˜ë¥¼ ì¬ë°˜ì˜í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nê¸°ì¡´ ì ìˆ˜ëŠ” ì´ˆê¸°í™”ë©ë‹ˆë‹¤.")) {
                return;
            }

        participants.forEach(p => {
            p.score = 0;
            p.conTotal = 0;
        });

        conLogHistory.forEach(log => {
            const participantIndex = participants.findIndex(p => p.blindName === log.participant);
            if (participantIndex !== -1) {
                participants[participantIndex].score += log.value;
                participants[participantIndex].conTotal += log.value;
            }
        });

        saveData();
        renderTable();
        console.log("âœ… ë¡œê·¸ë¥¼ ë°”íƒ•ìœ¼ë¡œ ëª¨ë“  ì ìˆ˜ ì¬ë°˜ì˜ ì™„ë£Œ!");
    };

    function triggerConfetti() {
        if (window.confetti) {
            window.confetti({
                particleCount: 50,
                spread: 90,
                origin: { y: 0.6 }
            });
        }
    }

    window.openModal = function () {
        document.getElementById('modal').style.display = 'block';
        setTimeout(() => document.getElementById('singer').focus(), 100);
    }

    function closeModal() {
        document.getElementById('modal').style.display = 'none';
    }

    function handleEnter(e) {
        if (e.key === "Enter") addEntry();
    }

    function addEntry() {
        const singer = document.getElementById('singer').value.trim();
        const song = document.getElementById('song').value.trim();
        if (!singer || !song) return alert("ì°¸ê°€ìëª…ê³¼ ë…¸ë˜ ì œëª©ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.");
        const blindName = `ì°¸ê°€ì${participants.length + 1}`;
        const newEntry = { singer, song, score: 0, conTotal: 0, blindName };
        for (let i = 1; i <= judgeCount; i++) newEntry[`judge${i}`] = 0;
        participants.push(newEntry);
        originalOrder.push(newEntry);
        renderTable(); saveData();
        document.getElementById('singer').value = '';
        document.getElementById('song').value = '';
        document.getElementById('singer').focus();
    }

    window.toggleSingerVisibility = function () {
        showSingers = !showSingers;
        document.getElementById('toggleBtn').textContent = showSingers ? 'ì°¸ê°€ì ê°ì¶¤' : 'ì°¸ê°€ì í‘œì‹œ';
        renderTable();
    }

    window.toggleSortMode = function () {
        const btn = document.getElementById('sortToggleBtn');
        if (!isSortedByScore) {
            participants.sort((a, b) => (b.scoreTotal || 0) - (a.scoreTotal || 0));
            isSortedByScore = true;
            btn.textContent = 'ìˆœì„œ ì •ë ¬';
        } else {
            participants = [...originalOrder];
            isSortedByScore = false;
            btn.textContent = 'ìˆœìœ„ ì •ë ¬';
        }
        document.querySelector("#scoreTable thead th:nth-child(2)").textContent = isSortedByScore ? "ìˆœìœ„" : "ìˆœì„œ";
        renderTable();
    }

    window.openLogModal = function () {
        console.log("ğŸ” 'ë¡œê·¸ ë³´ê¸°' ì°½ì„ ì—½ë‹ˆë‹¤. í˜„ì¬ conLogHistory:", conLogHistory);
        updateLogFilterOptions();
        document.getElementById("logFilterSelect").value = "";
        filterLogByParticipant();
        document.getElementById("logModal").style.display = "block";
    }

    window.openManualConModal = function () {
        document.getElementById('manualConModal').style.display = 'block';
    }

    function closeManualConModal() {
        document.getElementById('manualConModal').style.display = 'none';
    }

    function closeLogModal() {
        document.getElementById("logModal").style.display = "none";
    }

    function filterLogByParticipant() {
        const selected = document.getElementById("logFilterSelect").value;
        const logBox = document.getElementById("logContent");

        const filtered = conLogHistory.filter(log => {
            return selected === "" || log.participant === selected;
        });

        console.log(`ğŸ” í•„í„°ë§ ê²°ê³¼ (ì„ íƒ: '${selected}'):`, filtered);

        if (filtered.length === 0) {
            logBox.textContent = "í•´ë‹¹ ì°¸ê°€ìì—ê²Œ í• ë‹¹ëœ ì½˜ ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.";
        } else {
            logBox.textContent = filtered
                .map(log => `ğŸ¿ [${log.time}] ${log.nickname} â†’ ${log.participant} (${log.value}ì )`)
                .join("\n");
        }
    }

    function updateLogFilterOptions() {
        const select = document.getElementById("logFilterSelect");
        const currentValue = select.value;

        const uniqueNames = [...new Set(conLogHistory.map(log => log.participant))];

        select.innerHTML = `<option value="">ì „ì²´ ë³´ê¸°</option>`;
        uniqueNames.forEach(name => {
            const option = document.createElement("option");
            option.value = name;
            option.textContent = name;
            select.appendChild(option);
        });

        select.value = currentValue;
    }

    function renderTable() {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';
        participants.forEach((p, i) => {
            const name = showSingers ? p.singer : p.blindName;
            const judgeScores = Array.from({ length: judgeCount }, (_, j) => p[`judge${j + 1}`] || 0);
            const totalScore = judgeScores.reduce((a, b) => a + b, p.score);
            p.scoreTotal = totalScore;
            const tr = document.createElement('tr');
            tr.className = (i === activeIndex) ? 'active-row' : '';
            tr.innerHTML = `
                <td><input type="checkbox" onchange="setActive(${i})" ${i === activeIndex ? 'checked' : ''}></td>
                <td>${i + 1}</td>
                <td>${name}</td>
                <td>${p.song}</td>
                <td><button class="score-button" onclick="openScoreModal(${i})">ì ìˆ˜</button></td>
                <td>${p.conTotal || 0}</td>
                <td>${totalScore}</td>
            `;
            tbody.appendChild(tr);
        });
        document.getElementById('singerHeaderText').textContent = showSingers ? 'ì°¸ê°€ì (ê³µê°œ)' : 'ì°¸ê°€ì (ë¹„ê³µê°œ)';
    }

    function setActive(index) {
        activeIndex = (activeIndex === index) ? null : index;
        renderTable();
    }

    function openScoreModal(index) {
        currentScoreIndex = index;
        const p = participants[index];
        const container = document.getElementById('dynamicScoreInputs');
        container.innerHTML = '';
        for (let i = 0; i < judgeCount; i++) {
            const val = p[`judge${i + 1}`] || 0;
            container.innerHTML += `<label>ì ìˆ˜${i + 1}: <input type="number" id="scoreInput${i}" value="${val}"></label><br><br>`;
        }
        document.getElementById('toggleJudgeBtnModal').textContent = (judgeCount === 3) ? 'ì‚­ì œ' : 'ì¶”ê°€';
        document.getElementById('scoreInputModal').style.display = 'block';
    }

    function closeScoreModal() {
        document.getElementById('scoreInputModal').style.display = 'none';
    }

    function saveScores() {
        if (currentScoreIndex !== null) {
            for (let i = 0; i < judgeCount; i++) {
                const val = parseInt(document.getElementById(`scoreInput${i}`).value) || 0;
                participants[currentScoreIndex][`judge${i + 1}`] = val;
            }
            closeScoreModal();
            renderTable();
            saveData();
        }
    }

    function toggleJudgeFieldFromModal() {
        judgeCount = judgeCount === 3 ? 2 : 3;
        document.getElementById('toggleJudgeBtnModal').textContent = judgeCount === 3 ? 'ì‚­ì œ' : 'ì¶”ê°€';
        openScoreModal(currentScoreIndex);
    }

    function resetAll() {
        if (confirm("ì •ë§ ëª¨ë“  ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            localStorage.removeItem('participants');
            localStorage.removeItem('originalOrder');
            localStorage.removeItem('conLogHistory');
            localStorage.removeItem('assignedHistory');
            participants = [];
            originalOrder = [];
            conLogHistory = [];
            assignedHistory = new Set();
            renderTable();
        }
    }

    function resetSelectedCon() {
        const checkboxes = document.querySelectorAll('#tableBody input[type="checkbox"]');
        let changed = false;
        checkboxes.forEach((cb, i) => {
            if (cb.checked) {
                participants[i].conTotal = 0;
                participants[i].score = 0;
                for (let j = 1; j <= judgeCount; j++) {
                    participants[i][`judge${j}`] = 0;
                }
                participants[i].scoreTotal = 0;
                const ori = originalOrder[i];
                ori.conTotal = 0;
                ori.score = 0;
                for (let j = 1; j <= judgeCount; j++) {
                    ori[`judge${j}`] = 0;
                }
                ori.scoreTotal = 0;
                changed = true;
            }
        });
        if (changed) {
            const selectedBlindNames = Array.from(checkboxes)
                .filter(cb => cb.checked)
                .map((cb, i) => participants[i].blindName);
            conLogHistory = conLogHistory.filter(log => !selectedBlindNames.includes(log.participant));

            saveData();
            renderTable();
        } else {
            alert("ì„ íƒëœ ì°¸ê°€ìê°€ ì—†ìŠµë‹ˆë‹¤.");
        }
    }
    
    function applyManualCon() {
        const nickname = "ìˆ˜ë™ ë°˜ì˜";
        const targetInput = document.getElementById('manualTarget');
        const amountInput = document.getElementById('manualAmount');

        const target = parseInt(targetInput.value);
        const amount = parseInt(amountInput.value);

        if (isNaN(target) || isNaN(amount)) {
            alert("ì°¸ê°€ì ë²ˆí˜¸ì™€ ì½˜ ì ìˆ˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
        }

        const idx = target - 1;
        if (!participants[idx]) {
            alert("í•´ë‹¹ ì°¸ê°€ì ë²ˆí˜¸ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
            return;
        }

        participants[idx].score += amount;
        participants[idx].conTotal = (participants[idx].conTotal || 0) + amount;

        const blindName = participants[idx].blindName || `ì°¸ê°€ì${target}`;
        const logKey = `${nickname}|${blindName}|${amount}`;

        conLogHistory.push({
            nickname,
            participant: blindName,
            value: amount,
            time: new Date().toLocaleString(),
            logKey
        });
        assignedHistory.add(logKey);

        console.log(`ğŸ› ï¸ ìˆ˜ë™ ë°˜ì˜ ì™„ë£Œ: ${nickname} â†’ ${blindName} (${amount}ì )`);

        targetInput.value = '';
        amountInput.value = '';

        saveData();
        renderTable();
        updateLogFilterOptions();
        closeManualConModal();
    }

    function purgeDuplicateConScores() {
        if (!Array.isArray(conLogHistory)) return;

        const seenLogKeys = new Set();
        const validLogs = [];
        let totalScoreChange = 0;

        for (const log of conLogHistory) {
            const key = `${log.nickname}|${log.participant}|${log.value}`;
            
            if (!seenLogKeys.has(key)) {
                seenLogKeys.add(key);
                validLogs.push(log);
            } else {
                const idx = participants.findIndex(p => p.blindName === log.participant);
                if (idx !== -1) {
                    participants[idx].score -= log.value;
                    participants[idx].conTotal -= log.value;
                    totalScoreChange -= log.value;
                    console.log(`âŒ ì¤‘ë³µ ì½˜ ì ìˆ˜ ì°¨ê°ë¨: ${key} (${log.value}ì )`);
                }
            }
        }
        
        conLogHistory = validLogs;
        assignedHistory = seenLogKeys;
        
        saveData();
        renderTable();
        console.log(`âœ… ì¤‘ë³µ ì½˜ ì ìˆ˜ ì •ë¦¬ ì™„ë£Œ. ì´ ${-totalScoreChange}ì  ì°¨ê°ë¨`);
    }

    function saveData() {
        localStorage.setItem('participants', JSON.stringify(participants));
        localStorage.setItem('originalOrder', JSON.stringify(originalOrder));
        localStorage.setItem('conLogHistory', JSON.stringify(conLogHistory));
        localStorage.setItem('assignedHistory', JSON.stringify(Array.from(assignedHistory)));
        console.log("ğŸ“¥ ëª¨ë“  ë°ì´í„°ê°€ ë¡œì»¬ ì €ì¥ì†Œì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. (ë¡œê·¸ ìˆ˜: " + conLogHistory.length + ")");
    }

    function loadSavedData() {
        const saved = localStorage.getItem('participants');
        const original = localStorage.getItem('originalOrder');
        const logs = localStorage.getItem('conLogHistory');
        const assigned = localStorage.getItem('assignedHistory');
        
        if (saved) {
            try {
                participants = JSON.parse(saved);
                originalOrder = original ? JSON.parse(original) : [...participants];
                conLogHistory = logs ? JSON.parse(logs) : [];
                assignedHistory = assigned ? new Set(JSON.parse(assigned)) : new Set();
                
                participants.forEach((p, i) => {
                    if (!p.blindName) p.blindName = `ì°¸ê°€ì${i + 1}`;
                });
                originalOrder.forEach((p, i) => {
                    if (!p.blindName) p.blindName = `ì°¸ê°€ì${i + 1}`;
                });
                console.log("ğŸ“¤ ì €ì¥ëœ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤. (ë¡œê·¸ ìˆ˜: " + conLogHistory.length + ")");
                renderTable();
            } catch (e) {
                participants = [];
                originalOrder = [];
                conLogHistory = [];
                assignedHistory = new Set();
                console.error("ì €ì¥ëœ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ", e);
            }
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        loadSavedData();
        showVersion();
    });
</script>
</body>
</html>








